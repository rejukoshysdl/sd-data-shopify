name: Compare JSON Files Before Merge

on:
  pull_request_target:
    types:
      - synchronize  # When a new commit is pushed to the PR
      - ready_for_review  # When PR is marked "Ready for Merge"
      - reopened  # When a closed PR is reopened
      - labeled  # If a label like "ready to merge" is applied

jobs:
  diff_check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}  # Ensure we check the latest PR commit

      - name: Fetch Latest Branches
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}  # Destination branch (int or main)
          git fetch origin ${{ github.event.pull_request.head.ref }}  # Source branch (dev)

      - name: Create Diff Directory
        run: |
          mkdir -p ./changes/git-diff

      - name: Compare JSON Files in repo-shopify-data
        run: |
          DIFF_FILE="./changes/git-diff/changes.diff"
          
          # Run git diff on the latest PR commit vs destination branch
          git diff origin/${{ github.event.pull_request.base.ref }}..origin/${{ github.event.pull_request.head.ref }} -- 'repo-shopify-data/*.json' > $DIFF_FILE
          
          # Ensure the file is not empty
          if [ ! -s $DIFF_FILE ]; then
            echo "âœ… No JSON files changed in repo-shopify-data" > $DIFF_FILE
          fi

          cat $DIFF_FILE  # Show diff output for debugging

      - name: Upload Diff Report
        uses: actions/upload-artifact@v4
        with:
          name: json-diff-report
          path: ./changes/git-diff/changes.diff
